<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Primitive Physics Scene</title>

		<!-- Load A-Frame first -->
		<script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>
		<!-- <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script> -->

		<!-- Then load Ammo.js (physics engine) -->
		<script src="https://cdn.8thwall.com/web/aframe/ammo.wasm.js"></script>
		<!-- <script src="http://kripken.github.io/ammo.js/builds/ammo.wasm.js"></script> -->
		<!-- <script src="https://mixedreality.mozilla.org/ammo.js/builds/ammo.wasm.js"></script> -->

		<!-- Then load the A-Frame physics system -->
		<script src="https://unpkg.com/@c-frame/aframe-physics-system@4.2.2/dist/aframe-physics-system.min.js"></script>
		<!-- <script src="https://cdn.8thwall.com/web/aframe/aframe-physics-system-4.2.2.min.js"></script> -->
	</head>
	<body>
		<div>
			<ul>
				<li>"Space" to punch</li>
				<li>"R" to restart</li>
				<li>"W, A, S, D" to move</li>
				<li>"Shift" to move up</li>
				<li>"Ctrl" to move down</li>
			</ul>
		</div>
		<a-scene
			physics="driver: ammo; debug: false"
			renderer="colorManagement: true; webgl2: false">
			<a-entity
				light="type: directional; intensity: 0.8"
				position="1 4.3 2.5"></a-entity>
			<a-light type="ambient" intensity="0.5"></a-light>

			<a-asset>
				<a-asset-item id="cat-obj" src="cat/Cat.obj"></a-asset-item>
				<a-asset-item id="cat-mtl" src="cat/Cat.mtl"></a-asset-item>
			</a-asset>
			<a-entity
				rotation="-90 0 0"
				position="5 0 -10"
				obj-model="obj: #cat-obj; mtl: #cat-mtl"
				scale="0.3 0.3 0.3"></a-entity>

			<!-- Camera + Glove Box -->
			<a-camera
				id="camera"
				position="0 2 10"
				camera
				look-controls
				wasd-controls
				vertical-controls>
				<a-box
					id="glove"
					punch-tap
					color="red"
					depth="0.5"
					height="0.5"
					width="0.5"
					ammo-body="type: kinematic"
					ammo-shape="type: box"
					position="0 -1 -1"></a-box>
			</a-camera>

			<!-- Ball (Sphere) -->
			<a-sphere
				id="ball"
				radius="0.5"
				color="white"
				position="0 2 -3"
				ammo-body="type: dynamic"
				ammo-shape="type: sphere"></a-sphere>

			<!-- Bowling Pins (Cylinders) -->
			<a-cylinder
				color="red"
				height="1"
				radius="0.15"
				position="0 0.5 -7"
				ammo-body="type: dynamic"
				ammo-shape="type: cylinder"
				id="pin1"></a-cylinder>
			<a-cylinder
				color="red"
				height="1"
				radius="0.15"
				position="-0.5 0 -8.5"
				ammo-body="type: dynamic"
				ammo-shape="type: cylinder"
				id="pin2"></a-cylinder>
			<a-cylinder
				color="red"
				height="1"
				radius="0.15"
				position="0.5 0 -8.5"
				ammo-body="type: dynamic"
				ammo-shape="type: cylinder"
				id="pin3"></a-cylinder>
			<a-cylinder
				color="red"
				height="1"
				radius="0.15"
				position="0 0 -10"
				ammo-body="type: dynamic"
				ammo-shape="type: cylinder"
				id="pin4"></a-cylinder>
			<a-cylinder
				color="red"
				height="1"
				radius="0.15"
				position="-1 0 -10"
				ammo-body="type: dynamic"
				ammo-shape="type: cylinder"
				id="pin5"></a-cylinder>
			<a-cylinder
				color="red"
				height="1"
				radius="0.15"
				position="1 0 -10"
				ammo-body="type: dynamic"
				ammo-shape="type: cylinder"
				id="pin6"></a-cylinder>

			<!-- room -->
			<!-- left wall -->
			<a-plane
				rotation="0 90 0"
				height="10"
				width="20"
				color="yellow"
				ammo-body="type: static"
				ammo-shape="type: box"
				position="-10 1 -10"></a-plane>
			<!-- right wall -->
			<a-plane
				rotation="0 -90 0"
				height="10"
				width="20"
				color="pink"
				ammo-body="type: static"
				ammo-shape="type: box"
				position="10 1 -10"></a-plane>
			<!-- back wall -->
			<a-plane
				rotation="0 0 0"
				height="10"
				width="20"
				color="#0000ff"
				ammo-body="type: static"
				ammo-shape="type: box"
				position="0 1 -20"></a-plane>

			<!-- roof -->
			<a-plane
				rotation="90 0 0"
				height="20"
				width="20"
				color="#00ff00"
				ammo-body="type: static"
				ammo-shape="type: box"
				position="0 6 -10"></a-plane>
			<!-- Ground Plane -->
			<a-plane
				rotation="-90 0 0"
				height="100"
				width="100"
				color="#000"
				position="0 0 0"
				ammo-body="type: static"
				ammo-shape="type: box"></a-plane>
		</a-scene>

		<script>
			// Simple punch animation component
			AFRAME.registerComponent("punch-tap", {
				schema: {
					yOffset: { type: "number", default: -1 },
					zOffset: { type: "number", default: -1 },
				},
				init() {
					this.punchAnimation = () => {
						this.el.removeAttribute("animation");
						this.el.setAttribute(
							"animation",
							`property: position; dur: 125; from: 0 ${this.data.yOffset} ${this.data.zOffset}; to: 0 ${this.data.yOffset} -3; dir: alternate; loop: 2; easing: easeInOutQuad`
						);
					};

					this.el.sceneEl.addEventListener("keydown", this.punchAnimation);
					window.addEventListener("keydown", (e) => {
						if (e.key === " ") this.punchAnimation();
					});
				},
			});

			//Fly Controls Logic
			AFRAME.registerComponent("vertical-controls", {
				schema: {
					speed: { type: "number", default: 5 },
				},
				init: function () {
					this.velocity = 0;
					this.keys = {};

					window.addEventListener("keydown", (e) => {
						if (e.key === "Shift") this.keys["shift"] = true;
						if (e.key === "Control") this.keys["control"] = true;
					});

					window.addEventListener("keyup", (e) => {
						if (e.key === "Shift") this.keys["shift"] = false;
						if (e.key === "Control") this.keys["control"] = false;
					});
				},
				tick: function (time, deltaTime) {
					const el = this.el;
					const position = el.getAttribute("position");
					const delta = deltaTime / 1000;
					const speed = this.data.speed;

					if (this.keys["shift"]) {
						position.y += speed * delta;
					}

					if (this.keys["control"]) {
						position.y = Math.max(1, position.y - speed * delta);
					}

					el.setAttribute("position", position);
				},
			});

			// Add R key to reload page
			function resetGame() {
				window.location.reload();
			}
			window.addEventListener("keydown", (e) => {
				if (e.key === "r" || e.key === "R") {
					console.log("R key pressed - resetting game");
					resetGame();
				}
			});
		</script>
	</body>
</html>
