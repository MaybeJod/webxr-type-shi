<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>VR Physics Scene</title>

		<!-- aframe -->
		<script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>

		<!-- physics -->
		<script src="https://cdn.8thwall.com/web/aframe/ammo.wasm.js"></script>

		<script src="https://unpkg.com/@c-frame/aframe-physics-system@4.2.2/dist/aframe-physics-system.min.js"></script>

		<!-- controller -->
		<script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@6.1.1/dist/aframe-extras.controls.min.js"></script>
	</head>
	<body>
		<div id="instructions">
			<h3>Controls:</h3>
			<ul>
				<li>
					<strong>Desktop:</strong> "Space" to punch, "R" to restart, "W,A,S,D"
					to move, "Shift/Ctrl" for up/down
				</li>
				<li>
					<strong>VR:</strong> **Grip buttons to fly**, trigger buttons to punch
				</li>
				<li>
					<strong>Enter VR:</strong> Click the VR goggles icon in the bottom
					right
				</li>
			</ul>
		</div>

		<a-scene
			physics="driver: ammo; debug: true"
			renderer="colorManagement: true; webgl2: false"
			vr-mode-ui="enabled: true"
			device-orientation-permission-ui="enabled: false"
			keyboard-shortcuts="enterVR: false; exitVR: false"
			stats
			debug>
			<a-scene>
				<a-entity light="type: ambient; intensity: 0.5;"></a-entity>
				<a-entity
					light="type: directional;
                   castShadow: true;
                   intensity: 0.4;
                   shadowCameraVisible: true;"
					position="-10 3 1.5"></a-entity>
			</a-scene>

			<a-light type="probe" envMap="#pisa"></a-light>

			<a-assets>
				<a-asset-item id="cat-obj" src="cat/Cat.obj"></a-asset-item>
				<a-asset-item id="cat-mtl" src="cat/Cat.mtl"></a-asset-item>
				<a-asset-item id="jod" src="jod/jod.gltf"></a-asset-item>
			</a-assets>

			<a-entity
				id="cat"
				rotation="-90 0 0"
				position="5 5 -10"
				obj-model="obj: #cat-obj; mtl: #cat-mtl"
				scale="0.1 0.1 0.1"
				cat-physics></a-entity>

			<a-entity position="3 0 -4">
				<a-entity gltf-model="#jod" cat-physics position="0 0 0"></a-entity>
				<a-entity gltf-model="#jod" cat-physics position="1 0 0"></a-entity>
				<a-entity gltf-model="#jod" cat-physics position="0 0 1"></a-entity>
				<a-entity gltf-model="#jod" cat-physics position="1 0 1"></a-entity>
			</a-entity>
			<!-- <a-entity gltf-model="#jod" cat-physics position="3 0 -5"></a-entity>
			<a-entity gltf-model="#jod" cat-physics position="3 0 -6"></a-entity> -->

			<a-entity id="cameraRig" position="0 0 10">
				<a-camera
					id="head"
					position="0 1.6 0"
					look-controls
					wasd-controls="enabled: true; acceleration: 100"
					vertical-controls>
					<a-box
						id="cameraGlove"
						punch-tap
						color="red"
						depth="0.5"
						height="0.5"
						width="0.5"
						ammo-body="type: kinematic"
						ammo-shape="type: box"
						position="0 -1 -1"></a-box>
				</a-camera>

				<a-entity
					id="leftController"
					hand-controls="hand: left; handModelStyle: lowPoly; color: #ffcccc"
					vr-flight-controls="hand: left"
					animation-trigger="hand: left"
					tracked-controls-webxr="hand: left"
					controller-cursor
					vr-controller>
					<a-box
						id="leftGlove"
						color="blue"
						depth="0.3"
						height="0.3"
						width="0.3"
						position="0 0 -0.1"
						ammo-body="type: kinematic"
						ammo-shape="type: box"
						punch-controller="hand: left">
					</a-box>
				</a-entity>

				<a-entity
					id="rightController"
					hand-controls="hand: right; handModelStyle: lowPoly; color: #ffcccc"
					vr-flight-controls="hand: right"
					animation-trigger="hand: right"
					tracked-controls-webxr="hand: right"
					controller-cursor
					vr-controller>
					<a-box
						id="rightGlove"
						color="red"
						depth="0.3"
						height="0.3"
						width="0.3"
						position="0 0 -0.1"
						ammo-body="type: kinematic"
						ammo-shape="type: box"
						punch-controller="hand: right">
					</a-box>
				</a-entity>
			</a-entity>

			<a-sphere
				id="ball"
				radius="0.5"
				color="white"
				position="0 2 -3"
				ammo-body="type: dynamic"
				ammo-shape="type: sphere"></a-sphere>

			<a-cylinder
				color="red"
				height="1"
				radius="0.15"
				position="0 0.5 -7"
				ammo-body="type: dynamic"
				ammo-shape="type: cylinder"
				id="pin1"></a-cylinder>
			<a-cylinder
				color="red"
				height="1"
				radius="0.15"
				position="-0.5 0 -8.5"
				ammo-body="type: dynamic"
				ammo-shape="type: cylinder"
				id="pin2"></a-cylinder>
			<a-cylinder
				color="red"
				height="1"
				radius="0.15"
				position="0.5 0 -8.5"
				ammo-body="type: dynamic"
				ammo-shape="type: cylinder"
				id="pin3"></a-cylinder>
			<a-cylinder
				color="red"
				height="1"
				radius="0.15"
				position="0 0 -10"
				ammo-body="type: dynamic"
				ammo-shape="type: cylinder"
				id="pin4"></a-cylinder>
			<a-cylinder
				color="red"
				height="1"
				radius="0.15"
				position="-1 0 -10"
				ammo-body="type: dynamic"
				ammo-shape="type: cylinder"
				id="pin5"></a-cylinder>
			<a-cylinder
				color="red"
				height="1"
				radius="0.15"
				position="1 0 -10"
				ammo-body="type: dynamic"
				ammo-shape="type: cylinder"
				id="pin6"></a-cylinder>

			<a-plane
				rotation="0 90 0"
				height="10"
				width="20"
				color="yellow"
				ammo-body="type: static"
				ammo-shape="type: box"
				position="-10 1 -10"></a-plane>
			<a-plane
				rotation="0 -90 0"
				height="10"
				width="20"
				color="pink"
				ammo-body="type: static"
				ammo-shape="type: box"
				position="10 1 -10"></a-plane>
			<a-plane
				rotation="0 0 0"
				height="10"
				width="20"
				color="#0000ff"
				ammo-body="type: static"
				ammo-shape="type: box"
				position="0 1 -20"></a-plane>

			<a-plane
				rotation="90 0 0"
				height="20"
				width="20"
				color="#00ff00"
				ammo-body="type: static"
				ammo-shape="type: box"
				position="0 6 -10"></a-plane>

			<a-box
				rotation="0 0 0"
				height="1"
				width="100"
				depth="100"
				color="#000"
				position="0 -0.5 0"
				ammo-body="type: static; mass: 0"
				ammo-shape="type: box; halfExtents: 50 0.5 50"></a-box>
		</a-scene>

		<script>
			// Check if in VR mode
			function isVRMode() {
				return document.querySelector("a-scene").is("vr-mode");
			}

			// Component to add physics after model loads
			AFRAME.registerComponent("cat-physics", {
				init: function () {
					this.el.addEventListener("model-loaded", (e) => {
						console.log("Model loaded, adding physics...");
						this.el.setAttribute("ammo-body", {
							type: "dynamic",
							mass: 1,
							linearDamping: 0.1,
							angularDamping: 0.1,
						});
						this.el.setAttribute("ammo-shape", {
							type: "box",
						});
					});
				},
			});

			// VR Controller Component with axis logging for debugging
			AFRAME.registerComponent("vr-controller", {
				init: function () {
					this.el.addEventListener("controllerconnected", (evt) => {
						console.log(
							"Controller connected:",
							evt.detail.name,
							evt.detail.component
						);
					});

					// Add this for debugging joystick input (though vr-flight-controls uses grip)
					this.el.addEventListener("axismove", (evt) => {
						if (
							evt.detail.axis &&
							(Math.abs(evt.detail.axis[0]) > 0.01 ||
								Math.abs(evt.detail.axis[1]) > 0.01)
						) {
							console.log(`${this.el.id} axis moved:`, evt.detail.axis);
						}
					});
				},
			});

			// Enhanced punch component for VR controllers
			AFRAME.registerComponent("punch-controller", {
				schema: {
					hand: { type: "string", default: "right" },
				},
				init: function () {
					this.controller = this.el.parentEl;
					this.originalPosition = { x: 0, y: 0, z: -0.1 };
					this.punching = false;

					// Listen for trigger/grip button presses
					this.controller.addEventListener(
						"triggerdown",
						this.punch.bind(this)
					);
					this.controller.addEventListener("gripdown", this.punch.bind(this)); // Could also be used for punch if not for flight
					this.controller.addEventListener(
						"abuttondown",
						this.punch.bind(this)
					);
					this.controller.addEventListener(
						"bbuttondown",
						this.punch.bind(this)
					);
					this.controller.addEventListener(
						"xbuttondown",
						this.punch.bind(this)
					);
					this.controller.addEventListener(
						"ybuttondown",
						this.punch.bind(this)
					);
				},
				punch: function () {
					if (this.punching) return;
					this.punching = true;

					console.log(`${this.data.hand} hand punching!`);

					// Punch animation
					this.el.removeAttribute("animation");
					this.el.setAttribute("animation", {
						property: "position",
						dur: 150,
						from: "0 0 -0.1",
						to: "0 0 -0.5",
						dir: "alternate",
						loop: 2,
						easing: "easeInOutQuad",
					});

					// Reset punching state
					setTimeout(() => {
						this.punching = false;
					}, 300);
				},
			});

			// Desktop punch component (fallback)
			AFRAME.registerComponent("punch-tap", {
				schema: {
					yOffset: { type: "number", default: -1 },
					zOffset: { type: "number", default: -1 },
				},
				init() {
					this.punchAnimation = () => {
						this.el.removeAttribute("animation");
						this.el.setAttribute(
							"animation",
							`property: position; dur: 125; from: 0 ${this.data.yOffset} ${this.data.zOffset}; to: 0 ${this.data.yOffset} -3; dir: alternate; loop: 2; easing: easeInOutQuad`
						);
					};

					window.addEventListener("keydown", (e) => {
						if (e.key === " " && !isVRMode()) {
							this.punchAnimation();
						}
					});
				},
			});

			// VR Flight Controls Component
			AFRAME.registerComponent("vr-flight-controls", {
				schema: {
					hand: { type: "string", default: "right" },
					speed: { type: "number", default: 5 },
				},
				init: function () {
					const self = this;
					this.isGripPressed = false;
					this.cameraRig = null;

					// Wait for scene to load
					this.el.sceneEl.addEventListener("loaded", function () {
						self.cameraRig = document.querySelector("#cameraRig");
					});

					this.el.addEventListener("gripdown", function () {
						self.isGripPressed = true;
						console.log(`${self.data.hand} grip pressed - initiating flight.`);
					});

					this.el.addEventListener("gripup", function () {
						self.isGripPressed = false;
						console.log(`${self.data.hand} grip released - stopping flight.`);
					});
				},
				tick: function (time, deltaTime) {
					if (!this.isGripPressed || !this.cameraRig) return;

					// Use THREE.js for vector operations
					const rigPosition = this.cameraRig.getAttribute("position");
					const controllerObject = this.el.object3D; // Get the controller's 3D object

					if (controllerObject && controllerObject.quaternion) {
						const forward = new THREE.Vector3(0, 0, -1); // Forward is typically -Z in A-Frame
						forward.applyQuaternion(controllerObject.quaternion); // Apply controller's rotation

						const delta = deltaTime / 1000; // Convert deltaTime to seconds
						const speed = this.data.speed;

						// Move in the direction the controller is pointing
						rigPosition.x += forward.x * speed * delta;
						rigPosition.y += forward.y * speed * delta;
						rigPosition.z += forward.z * speed * delta;

						this.cameraRig.setAttribute("position", rigPosition);
					}
				},
			});

			// Desktop-only vertical controls (moved here for clarity and explicit VR check)
			AFRAME.registerComponent("vertical-controls", {
				schema: {
					speed: { type: "number", default: 3 },
				},
				init: function () {
					this.keys = {};

					window.addEventListener("keydown", (e) => {
						if (e.key === "Shift") this.keys["shift"] = true;
						if (e.key === "Control" || e.key === "c" || e.key === "C")
							this.keys["ctrl"] = true;
					});

					window.addEventListener("keyup", (e) => {
						if (e.key === "Shift") this.keys["shift"] = false;
						if (e.key === "Control" || e.key === "c" || e.key === "C")
							this.keys["ctrl"] = false;
					});
				},
				tick: function (time, deltaTime) {
					if (isVRMode()) return; // Only apply desktop controls when not in VR

					const cameraRig = document.querySelector("#cameraRig"); // Get cameraRig directly
					if (!cameraRig) return;

					const rigPosition = cameraRig.getAttribute("position");
					const delta = deltaTime / 1000;
					const speed = this.data.speed;

					if (this.keys["shift"]) {
						rigPosition.y += speed * delta;
						cameraRig.setAttribute("position", rigPosition);
					}

					if (this.keys["ctrl"]) {
						rigPosition.y = Math.max(0.5, rigPosition.y - speed * delta);
						cameraRig.setAttribute("position", rigPosition);
					}
				},
			});

			// VR mode detection and UI management
			AFRAME.registerComponent("vr-mode-handler", {
				init: function () {
					const sceneEl = this.el;
					const desktopGlove = document.querySelector("#cameraGlove");
					const leftGlove = document.querySelector("#leftGlove");
					const rightGlove = document.querySelector("#rightGlove");

					sceneEl.addEventListener("enter-vr", () => {
						console.log("Entered VR mode - VR flight controls active");
						if (desktopGlove) desktopGlove.setAttribute("visible", false);
						if (leftGlove) leftGlove.setAttribute("visible", true); // Make VR gloves visible
						if (rightGlove) rightGlove.setAttribute("visible", true);
					});

					sceneEl.addEventListener("exit-vr", () => {
						console.log("Exited VR mode");
						if (desktopGlove) desktopGlove.setAttribute("visible", true);
						if (leftGlove) leftGlove.setAttribute("visible", false); // Hide VR gloves
						if (rightGlove) rightGlove.setAttribute("visible", false);
					});
				},
			});

			// Add the VR mode handler to the scene
			document.querySelector("a-scene").setAttribute("vr-mode-handler", "");

			// Reset game function
			function resetGame() {
				window.location.reload();
			}

			window.addEventListener("keydown", (e) => {
				if (e.key === "r" || e.key === "R") {
					console.log("R key pressed - resetting game");
					resetGame();
				}
			});
		</script>

		<style>
			#instructions {
				position: absolute;
				top: 10px;
				left: 10px;
				background: rgba(0, 0, 0, 0.8);
				color: white;
				padding: 15px;
				border-radius: 5px;
				font-family: Arial, sans-serif;
				z-index: 999;
				max-width: 400px;
			}
			#instructions h3 {
				margin-top: 0;
				color: #4caf50;
			}
			#instructions ul {
				margin: 10px 0;
				padding-left: 20px;
			}
			#instructions li {
				margin: 5px 0;
			}
		</style>
	</body>
</html>
