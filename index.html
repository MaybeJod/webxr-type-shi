<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>VR Physics Scene</title>

		<!-- Load A-Frame first -->
		<script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>

		<!-- Then load Ammo.js (physics engine) -->
		<script src="https://cdn.8thwall.com/web/aframe/ammo.wasm.js"></script>

		<!-- Then load the A-Frame physics system -->
		<script src="https://unpkg.com/@c-frame/aframe-physics-system@4.2.2/dist/aframe-physics-system.min.js"></script>
	</head>
	<body>
		<div
			id="desktop-controls"
			style="
				position: absolute;
				top: 10px;
				left: 10px;
				z-index: 100;
				background: rgba(0, 0, 0, 0.7);
				color: white;
				padding: 10px;
				border-radius: 5px;
			">
			<h3>Desktop Controls:</h3>
			<ul>
				<li>"Space" to punch</li>
				<li>"R" to restart</li>
				<li>"W, A, S, D" to move</li>
				<li>"Shift" to move up</li>
				<li>"C" to move down</li>
			</ul>
			<h3>VR Controls:</h3>
			<ul>
				<li>Trigger to punch with controllers</li>
				<li>Thumbstick/Trackpad to move</li>
				<li>Hand tracking supported</li>
			</ul>
		</div>

		<a-scene
			physics="driver: ammo; debug: false"
			renderer="colorManagement: true; webgl2: false"
			vr-mode-ui="enabled: true"
			embedded
			style="height: 100vh; width: 100vw">
			<!-- Lighting -->
			<a-entity
				light="type: directional; intensity: 0.8"
				position="1 4.3 2.5"></a-entity>
			<a-light type="ambient" intensity="0.5"></a-light>

			<!-- Assets -->
			<a-assets>
				<a-asset-item id="cat-obj" src="cat/Cat.obj"></a-asset-item>
				<a-asset-item id="cat-mtl" src="cat/Cat.mtl"></a-asset-item>
			</a-assets>

			<!-- Cat Model -->
			<a-entity
				rotation="-90 0 0"
				position="5 0 -10"
				obj-model="obj: #cat-obj; mtl: #cat-mtl"
				scale="0.3 0.3 0.3"></a-entity>

			<!-- VR Rig with Camera and Controllers -->
			<a-entity
				id="rig"
				movement-controls="fly: false; constrainToNavMesh: false"
				position="0 0 10">
				<!-- Camera -->
				<a-camera
					id="camera"
					position="0 1.6 0"
					look-controls="pointerLockEnabled: true"
					wasd-controls="acceleration: 20"
					vertical-controls></a-camera>

				<!-- Left Hand/Controller -->
				<a-entity
					id="leftHand"
					hand-controls="hand: left; handModelStyle: lowPoly; color: #ffb300"
					laser-controls="hand: left"
					vr-punch-controller="hand: left"
					position="-0.3 1.4 -0.3">
					<!-- Left Hand Glove for Desktop Mode -->
					<a-box
						id="leftGlove"
						color="blue"
						depth="0.3"
						height="0.3"
						width="0.3"
						ammo-body="type: kinematic"
						ammo-shape="type: box"
						visible="false"
						position="0 0 -0.2"></a-box>
				</a-entity>

				<!-- Right Hand/Controller -->
				<a-entity
					id="rightHand"
					hand-controls="hand: right; handModelStyle: lowPoly; color: #ffb300"
					laser-controls="hand: right"
					vr-punch-controller="hand: right"
					position="0.3 1.4 -0.3">
					<!-- Right Hand Glove -->
					<a-box
						id="rightGlove"
						color="red"
						depth="0.3"
						height="0.3"
						width="0.3"
						ammo-body="type: kinematic"
						ammo-shape="type: box"
						visible="true"
						position="0 0 -0.2"></a-box>
				</a-entity>

				<!-- Desktop Punch Glove (attached to camera for non-VR) -->
				<a-box
					id="desktopGlove"
					punch-tap
					color="red"
					depth="0.5"
					height="0.5"
					width="0.5"
					ammo-body="type: kinematic"
					ammo-shape="type: box"
					position="0 0.4 -1"
					visible="true"></a-box>
			</a-entity>

			<!-- Ball (Sphere) -->
			<a-sphere
				id="ball"
				radius="0.5"
				color="white"
				position="0 2 -3"
				ammo-body="type: dynamic"
				ammo-shape="type: sphere"></a-sphere>

			<!-- Bowling Pins (Cylinders) -->
			<a-cylinder
				color="red"
				height="1"
				radius="0.15"
				position="0 0.5 -7"
				ammo-body="type: dynamic"
				ammo-shape="type: cylinder"
				id="pin1"></a-cylinder>
			<a-cylinder
				color="red"
				height="1"
				radius="0.15"
				position="-0.5 0.5 -8.5"
				ammo-body="type: dynamic"
				ammo-shape="type: cylinder"
				id="pin2"></a-cylinder>
			<a-cylinder
				color="red"
				height="1"
				radius="0.15"
				position="0.5 0.5 -8.5"
				ammo-body="type: dynamic"
				ammo-shape="type: cylinder"
				id="pin3"></a-cylinder>
			<a-cylinder
				color="red"
				height="1"
				radius="0.15"
				position="0 0.5 -10"
				ammo-body="type: dynamic"
				ammo-shape="type: cylinder"
				id="pin4"></a-cylinder>
			<a-cylinder
				color="red"
				height="1"
				radius="0.15"
				position="-1 0.5 -10"
				ammo-body="type: dynamic"
				ammo-shape="type: cylinder"
				id="pin5"></a-cylinder>
			<a-cylinder
				color="red"
				height="1"
				radius="0.15"
				position="1 0.5 -10"
				ammo-body="type: dynamic"
				ammo-shape="type: cylinder"
				id="pin6"></a-cylinder>

			<!-- Room Walls -->
			<!-- Left wall -->
			<a-plane
				rotation="0 90 0"
				height="10"
				width="20"
				color="yellow"
				ammo-body="type: static"
				ammo-shape="type: box"
				position="-10 2.5 -10"></a-plane>
			<!-- Right wall -->
			<a-plane
				rotation="0 -90 0"
				height="10"
				width="20"
				color="pink"
				ammo-body="type: static"
				ammo-shape="type: box"
				position="10 2.5 -10"></a-plane>
			<!-- Back wall -->
			<a-plane
				rotation="0 0 0"
				height="10"
				width="20"
				color="#0000ff"
				ammo-body="type: static"
				ammo-shape="type: box"
				position="0 2.5 -20"></a-plane>

			<!-- Roof -->
			<a-plane
				rotation="90 0 0"
				height="20"
				width="20"
				color="#00ff00"
				ammo-body="type: static"
				ammo-shape="type: box"
				position="0 6 -10"></a-plane>

			<!-- Ground Plane -->
			<a-plane
				rotation="-90 0 0"
				height="100"
				width="100"
				color="#333"
				position="0 0 0"
				ammo-body="type: static"
				ammo-shape="type: box"></a-plane>
		</a-scene>

		<script>
			// VR Controller Punch Component
			AFRAME.registerComponent("vr-punch-controller", {
				schema: {
					hand: { type: "string", default: "right" },
				},
				init() {
					this.onTriggerDown = this.onTriggerDown.bind(this);
					this.onGripDown = this.onGripDown.bind(this);
					this.glove = null;

					// Wait for scene to load
					this.el.sceneEl.addEventListener("loaded", () => {
						this.setupController();
					});
				},

				setupController() {
					// Get the glove element for this hand
					this.glove = this.el.querySelector(`#${this.data.hand}Glove`);

					// Listen for controller events
					this.el.addEventListener("triggerdown", this.onTriggerDown);
					this.el.addEventListener("gripdown", this.onGripDown);
				},

				onTriggerDown() {
					this.punch();
				},

				onGripDown() {
					this.punch();
				},

				punch() {
					if (!this.glove) return;

					// Animate the glove forward
					this.glove.removeAttribute("animation");
					this.glove.setAttribute(
						"animation",
						`property: position; dur: 200; from: 0 0 -0.2; to: 0 0 -0.8; dir: alternate; loop: 2; easing: easeInOutQuad`
					);

					// Add force to nearby objects (simplified physics interaction)
					this.addForceToNearbyObjects();
				},

				addForceToNearbyObjects() {
					const glovePosition = this.glove.object3D.getWorldPosition(
						new THREE.Vector3()
					);
					const scene = this.el.sceneEl;

					// Find all dynamic physics objects
					const dynamicObjects = scene.querySelectorAll(
						'[ammo-body="type: dynamic"]'
					);

					dynamicObjects.forEach((obj) => {
						const objPosition = obj.object3D.getWorldPosition(
							new THREE.Vector3()
						);
						const distance = glovePosition.distanceTo(objPosition);

						// If object is close enough, apply force
						if (distance < 2) {
							const direction = objPosition
								.clone()
								.sub(glovePosition)
								.normalize();
							const force = direction.multiplyScalar(15); // Adjust force strength

							// Apply impulse if the object has ammo body
							const body = obj.body;
							if (body) {
								const impulse = new Ammo.btVector3(force.x, force.y, force.z);
								const pos = new Ammo.btVector3(0, 0, 0);
								body.applyImpulse(impulse, pos);
								Ammo.destroy(impulse);
								Ammo.destroy(pos);
							}
						}
					});
				},
			});

			// Enhanced punch animation component for desktop
			AFRAME.registerComponent("punch-tap", {
				schema: {
					yOffset: { type: "number", default: 0.4 },
					zOffset: { type: "number", default: -1 },
				},
				init() {
					this.punchAnimation = () => {
						this.el.removeAttribute("animation");
						this.el.setAttribute(
							"animation",
							`property: position; dur: 125; from: 0 ${this.data.yOffset} ${this.data.zOffset}; to: 0 ${this.data.yOffset} -2; dir: alternate; loop: 2; easing: easeInOutQuad`
						);

						// Add physics interaction
						this.addForceToNearbyObjects();
					};

					window.addEventListener("keydown", (e) => {
						if (e.key === " ") {
							e.preventDefault();
							this.punchAnimation();
						}
					});
				},

				addForceToNearbyObjects() {
					const glovePosition = this.el.object3D.getWorldPosition(
						new THREE.Vector3()
					);
					const scene = this.el.sceneEl;

					// Find all dynamic physics objects
					const dynamicObjects = scene.querySelectorAll(
						'[ammo-body="type: dynamic"]'
					);

					dynamicObjects.forEach((obj) => {
						const objPosition = obj.object3D.getWorldPosition(
							new THREE.Vector3()
						);
						const distance = glovePosition.distanceTo(objPosition);

						// If object is close enough, apply force
						if (distance < 3) {
							const direction = objPosition
								.clone()
								.sub(glovePosition)
								.normalize();
							const force = direction.multiplyScalar(20); // Adjust force strength

							// Apply impulse if the object has ammo body
							const body = obj.body;
							if (body) {
								const impulse = new Ammo.btVector3(force.x, force.y, force.z);
								const pos = new Ammo.btVector3(0, 0, 0);
								body.applyImpulse(impulse, pos);
								Ammo.destroy(impulse);
								Ammo.destroy(pos);
							}
						}
					});
				},
			});

			// Enhanced vertical controls
			AFRAME.registerComponent("vertical-controls", {
				schema: {
					speed: { type: "number", default: 5 },
				},
				init: function () {
					this.velocity = 0;
					this.keys = {};

					window.addEventListener("keydown", (e) => {
						if (e.key === "Shift") this.keys["shift"] = true;
						if (e.key === "c" || e.key === "C") this.keys["c"] = true;
					});

					window.addEventListener("keyup", (e) => {
						if (e.key === "Shift") this.keys["shift"] = false;
						if (e.key === "c" || e.key === "C") this.keys["c"] = false;
					});
				},
				tick: function (time, deltaTime) {
					// Only apply vertical controls in desktop mode
					if (this.el.sceneEl.is("vr-mode")) return;

					const el = this.el.parentEl; // Apply to the rig instead of camera
					const position = el.getAttribute("position");
					const delta = deltaTime / 1000;
					const speed = this.data.speed;

					if (this.keys["shift"]) {
						position.y += speed * delta;
					}

					if (this.keys["c"]) {
						position.y = Math.max(0.1, position.y - speed * delta);
					}

					el.setAttribute("position", position);
				},
			});

			// VR Mode Detection and UI Management
			AFRAME.registerComponent("vr-mode-handler", {
				init() {
					const scene = this.el;
					const desktopControls = document.getElementById("desktop-controls");
					const desktopGlove = document.getElementById("desktopGlove");
					const leftGlove = document.getElementById("leftGlove");
					const rightGlove = document.getElementById("rightGlove");

					scene.addEventListener("enter-vr", () => {
						console.log("Entered VR mode");
						if (desktopControls) desktopControls.style.display = "none";
						if (desktopGlove) desktopGlove.setAttribute("visible", false);
						if (leftGlove) leftGlove.setAttribute("visible", true);
						if (rightGlove) rightGlove.setAttribute("visible", true);
					});

					scene.addEventListener("exit-vr", () => {
						console.log("Exited VR mode");
						if (desktopControls) desktopControls.style.display = "block";
						if (desktopGlove) desktopGlove.setAttribute("visible", true);
						if (leftGlove) leftGlove.setAttribute("visible", false);
						if (rightGlove) rightGlove.setAttribute("visible", false);
					});
				},
			});

			// Apply VR mode handler to scene
			document.querySelector("a-scene").setAttribute("vr-mode-handler", "");

			// Reset game functionality
			function resetGame() {
				window.location.reload();
			}

			window.addEventListener("keydown", (e) => {
				if (e.key === "r" || e.key === "R") {
					console.log("R key pressed - resetting game");
					resetGame();
				}
			});
		</script>
	</body>
</html>
